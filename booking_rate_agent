#! /usr/bin/env ruby

# New Relic plugin to monitor FareHarbor booking rate.

require "rubygems"
require "bundler/setup"
require "newrelic_plugin"
require "pg"

module BookingRateAgent

  class Agent < NewRelic::Plugin::Agent::Base

    agent_guid "com.fareharbor.booking_rate"
    agent_version "1.0.1"
    agent_config_options :pg_host, :pg_port, :pg_database, :pg_username, :pg_password, :environment
    agent_human_labels("Booking Rate Agent") { "#{environment}" }

    def query_db(query)
      connection = PGconn.open(:host => pg_host, :port => pg_port, :dbname => pg_database, :user => pg_username, :password => pg_password)
      response = connection.exec(query)
      return response.getvalue(0,0)
    end

    def get_online_booking_count()
      return query_db("SELECT count(*) FROM charter_booking WHERE original_created_at > now() - interval '1 minute' AND original_user_id IS NULL")
    end

    def get_affiliate_booking_count()
      return query_db("SELECT count(*) FROM charter_booking WHERE original_created_at > now() - interval '1 minute' AND original_user_id IS NOT NULL and affiliation_id IS NOT NULL")
    end

    def get_direct_booking_count()
      return query_db("SELECT count(*) FROM charter_booking WHERE original_created_at > now() - interval '1 minute' AND original_user_id IS NOT NULL and affiliation_id IS NULL")
    end

    def poll_cycle
      online_bookings_count = get_online_booking_count()
      affiliate_bookings_count = get_affiliate_booking_count()
      direct_bookings_count = get_direct_booking_count()
      report_metric "BookingRate/online", "Value", online_bookings_count
      report_metric "BookingRate/affiliate", "Value", affiliate_bookings_count
      report_metric "BookingRate/direct", "Value", direct_bookings_count
      report_metric "BookingRate/all", "Value", online_bookings_count + affiliate_bookings_count + direct_bookings_count
    end

  end

  # Register this agent with the component.
  NewRelic::Plugin::Setup.install_agent :booking_rate, BookingRateAgent

  # Launch the agent; this never returns.
  NewRelic::Plugin::Run.setup_and_run

end
